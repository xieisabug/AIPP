name: Release

on:
    push:
        tags: [v\d+\.\d+\.\d+]
    workflow_dispatch:

jobs:
    create-release:
        permissions:
            contents: write
        runs-on: ubuntu-latest
        outputs:
            release_id: ${{ steps.create-release.outputs.id }}
            release_upload_url: ${{ steps.create-release.outputs.upload_url }}
            release_body: "${{ steps.changelog.outputs.changelog }}"

        steps:
            - uses: actions/checkout@v4
              with:
                  fetch-depth: 0

            - name: Get version
              id: get_version
              uses: battila7/get-version-action@v2

            - name: Generate changelog
              id: changelog
              run: |
                  # è·å–å½“å‰ç‰ˆæœ¬ tag
                  CURRENT_TAG="${{ steps.get_version.outputs.version }}"

                  # è·å–ä¸Šä¸€ä¸ªç‰ˆæœ¬ tag
                  PREV_TAG=$(git describe --tags --abbrev=0 HEAD^ 2>/dev/null || echo "")

                  if [ -z "$PREV_TAG" ]; then
                      # å¦‚æœæ²¡æœ‰ä¸Šä¸€ä¸ª tagï¼Œè·å–æ‰€æœ‰ commit
                      COMMITS=$(git log --pretty=format:"- %s (%h)" --reverse)
                      CHANGELOG="## ğŸ‰ Release $CURRENT_TAG

                  è¿™æ˜¯é¦–æ¬¡å‘å¸ƒï¼

                  ### ğŸ“ æ›´æ–°å†…å®¹

                  $COMMITS"
                  else
                      # è·å–ä¸¤ä¸ª tag ä¹‹é—´çš„ commits
                      COMMITS=$(git log ${PREV_TAG}..${CURRENT_TAG} --pretty=format:"- %s (%h)" --reverse)

                      # æŒ‰ç±»å‹åˆ†ç»„ commit
                  FEATURES=$(echo "$COMMITS" | grep -i "^-.*feat\|^-.*æ–°å¢\|^-.*æ·»åŠ " || echo "")
                  FIXES=$(echo "$COMMITS" | grep -i "^-.*fix\|^-.*ä¿®å¤\|^-.*bug" || echo "")
                  DOCS=$(echo "$COMMITS" | grep -i "^-.*doc\|^-.*æ–‡æ¡£\|^-.*æ›´æ–°è¯´æ˜" || echo "")
                  REFACTOR=$(echo "$COMMITS" | grep -i "^-.*refactor\|^-.*é‡æ„\|^-.*ä¼˜åŒ–" || echo "")
                  OTHER=$(echo "$COMMITS" | grep -v -i "^-.*feat\|^-.*æ–°å¢\|^-.*æ·»åŠ \|^-.*fix\|^-.*ä¿®å¤\|^-.*bug\|^-.*doc\|^-.*æ–‡æ¡£\|^-.*æ›´æ–°è¯´æ˜\|^-.*refactor\|^-.*é‡æ„\|^-.*ä¼˜åŒ–" || echo "")

                  CHANGELOG="## ğŸ‰ Release $CURRENT_TAG

                  ### âœ¨ æ–°åŠŸèƒ½
                  $FEATURES

                  ### ğŸ› Bug ä¿®å¤
                  $FIXES

                  ### ğŸ“š æ–‡æ¡£
                  $DOCS

                  ### â™»ï¸ é‡æ„ & ä¼˜åŒ–
                  $REFACTOR

                  ### ğŸ”§ å…¶ä»–
                  $OTHER"
                  fi

                  # ä¿å­˜åˆ°æ–‡ä»¶ä¾›åç»­ä½¿ç”¨
                  echo "$CHANGELOG" > changelog.md

                  # è®¾ç½®è¾“å‡ºï¼ˆæ³¨æ„å¤„ç†å¤šè¡Œå†…å®¹ï¼‰
                  {
                      echo 'changelog<<EOF'
                      cat changelog.md
                      echo EOF
                  } >> $GITHUB_OUTPUT

            - name: Create Release
              id: create-release
              uses: ncipollo/release-action@v1
              with:
                  draft: true
                  name: ${{ steps.get_version.outputs.version }}
                  tag: ${{ steps.get_version.outputs.version }}
                  body: "${{ steps.changelog.outputs.changelog }}"

    build-tauri:
        needs: create-release
        permissions:
            contents: write
        strategy:
            fail-fast: false
            matrix:
                include:
                    - os: ubuntu-latest
                      arch: x86_64
                      target: x86_64-unknown-linux-gnu
                      bundle_target: appimage
                    - os: macos-latest
                      arch: x64
                      target: x86_64-apple-darwin
                      bundle_target: dmg
                    - os: macos-latest
                      arch: arm64
                      target: aarch64-apple-darwin
                      bundle_target: dmg
                    - os: windows-latest
                      arch: x86_64
                      target: x86_64-pc-windows-msvc
                      bundle_target: msi

        runs-on: ${{ matrix.os }}
        steps:
            - uses: actions/checkout@v4

            - name: Get version
              id: get_version
              uses: battila7/get-version-action@v2

            - name: Setup pnpm
              uses: pnpm/action-setup@v4
              with:
                  version: 10

            - name: Setup Node.js
              uses: actions/setup-node@v4
              with:
                  node-version: 22
                  cache: 'pnpm'

            - name: Install dependencies
              run: pnpm install

            - name: Install system dependencies (Ubuntu)
              if: matrix.os == 'ubuntu-latest'
              run: |
                  sudo apt-get update
                  sudo apt-get install -y libwebkit2gtk-4.1-dev \
                      libayatana-appindicator3-dev librsvg2-dev patchelf \
                      libxdo-dev

            - name: Build Tauri App
              id: build
              uses: tauri-apps/tauri-action@v0.5.6
              env:
                  GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
                  TAURI_PRIVATE_KEY: ${{ secrets.TAURI_PRIVATE_KEY }}
              with:
                  releaseId: ${{ needs.create-release.outputs.release_id }}
                  releaseBody: ${{ needs.create-release.outputs.release_body }}
                  tauriScript: pnpm run tauri

    # ç”Ÿæˆå¹¶ä¸Šä¼  latest.json æ–‡ä»¶ï¼ˆå¸¦ç­¾åï¼‰
    generate-latest-json:
        needs: [create-release, build-tauri]
        permissions:
            contents: write
        runs-on: ubuntu-latest
        outputs:
            version: ${{ steps.get_version.outputs.version }}

        steps:
            - uses: actions/checkout@v4

            - name: Get version
              id: get_version
              uses: battila7/get-version-action@v2

            - name: Get release assets and signatures
              id: get_assets
              uses: actions/github-script@v6
              env:
                  release_id: ${{ needs.create-release.outputs.release_id }}
              with:
                script: |
                  const release = await github.rest.repos.getRelease({
                    owner: context.repo.owner,
                    repo: context.repo.repo,
                    release_id: process.env.release_id,
                  });

                  // æ”¶é›†ç­¾åæ–‡ä»¶
                  const signatures = {};
                  const bundleUrls = {};

                  for (const asset of release.data.assets) {
                    const name = asset.name;

                    // .sig æ–‡ä»¶æ˜¯ tauri-action è‡ªåŠ¨ç”Ÿæˆçš„ç­¾å
                    if (name.endsWith('.sig')) {
                      const assetName = name.replace('.sig', '').replace(/^bundle\//, '');
                      // è¯»å–ç­¾åå†…å®¹
                      const response = await github.request(asset.browser_download_url);
                      signatures[assetName] = Buffer.from(response.data).toString('base64');
                    }

                    // è®°å½• bundle URL
                    if (name.includes('.AppImage.tar.gz') || name.includes('.dmg.zip') || name.includes('.msi.zip')) {
                      const ext = name.includes('.AppImage') ? 'linux-x86_64' :
                                  name.includes('x64.dmg') ? 'darwin-x86_64' :
                                  name.includes('aarch64.dmg') ? 'darwin-aarch64' :
                                  name.includes('msi') ? 'windows-x86_64' : '';
                      if (ext) {
                        bundleUrls[ext] = asset.browser_download_url;
                      }
                    }
                  }

                  console.log('Signatures:', JSON.stringify(signatures, null, 2));
                  console.log('Bundle URLs:', JSON.stringify(bundleUrls, null, 2));

                  // è¾“å‡ºä¸ºç¯å¢ƒå˜é‡ä¾›ä¸‹ä¸€æ­¥ä½¿ç”¨
                  const fs = require('fs');
                  fs.writeFileSync('signatures.json', JSON.stringify(signatures, null, 2));
                  fs.writeFileSync('urls.json', JSON.stringify(bundleUrls, null, 2));

            - name: Generate latest.json with signatures
              id: generate_json
              run: |
                  # è·å–å½“å‰æ—¶é—´ï¼ˆISO 8601 æ ¼å¼ï¼‰
                  PUB_DATE=$(date -u +"%Y-%m-%dT%H:%M:%SZ")

                  # è¯»å– changelog
                  CHANGELOG="${{ needs.create-release.outputs.release_body }}"
                  # è½¬ä¹‰æ¢è¡Œç¬¦ä¸º JSON å­—ç¬¦ä¸²
                  NOTES_JSON=$(echo "$CHANGELOG" | jq -Rs .)

                  # è¯»å–ç­¾åå’Œ URLs
                  SIGNATURES=$(cat signatures.json)
                  URLS=$(cat urls.json)

                  # è·å–ç‰ˆæœ¬å·ï¼ˆå»æ‰ v å‰ç¼€ï¼‰
                  VERSION="${{ steps.get_version.outputs.version }}"
                  VERSION=${VERSION#v}

                  # ç”Ÿæˆ latest.json æ–‡ä»¶
                  cat > latest.json << EOF
                  {
                    "version": "${VERSION}",
                    "notes": $NOTES_JSON,
                    "pub_date": "$PUB_DATE",
                    "platforms": {
                      "linux-x86_64": {
                        "signature": "$(echo "$SIGNATURES" | jq -r '.["Aipp_'${VERSION}'_amd64.AppImage.tar.gz"] // ""')",
                        "url": "$(echo "$URLS" | jq -r '.["linux-x86_64"] // ""')"
                      },
                      "darwin-x86_64": {
                        "signature": "$(echo "$SIGNATURES" | jq -r '.["Aipp_'${VERSION}'_x64.dmg.zip"] // ""')",
                        "url": "$(echo "$URLS" | jq -r '.["darwin-x86_64"] // ""')"
                      },
                      "darwin-aarch64": {
                        "signature": "$(echo "$SIGNATURES" | jq -r '.["Aipp_'${VERSION}'_aarch64.dmg.zip"] // ""')",
                        "url": "$(echo "$URLS" | jq -r '.["darwin-aarch64"] // ""')"
                      },
                      "windows-x86_64": {
                        "signature": "$(echo "$SIGNATURES" | jq -r '.["Aipp_'${VERSION}'_x64_en-US.msi.zip"] // ""')",
                        "url": "$(echo "$URLS" | jq -r '.["windows-x86_64"] // ""')"
                      }
                    }
                  }
                  EOF

                  # æ ¼å¼åŒ– JSON
                  jq . latest.json > latest.json.tmp
                  mv latest.json.tmp latest.json

                  echo "Generated latest.json:"
                  cat latest.json

            - name: Upload latest.json to Release
              uses: actions/github-script@v6
              env:
                  release_id: ${{ needs.create-release.outputs.release_id }}
              with:
                script: |
                  const fs = require('fs');
                  const latestJson = fs.readFileSync('latest.json', 'utf8');

                  await github.rest.repos.uploadReleaseAsset({
                    owner: context.repo.owner,
                    repo: context.repo.repo,
                    release_id: process.env.release_id,
                    name: 'latest.json',
                    data: latestJson
                  });

    publish-release:
        permissions:
            contents: write
        runs-on: ubuntu-latest
        needs: [create-release, build-tauri, generate-latest-json]

        steps:
            - name: publish release
              id: publish-release
              uses: actions/github-script@v6
              env:
                  release_id: ${{ needs.create-release.outputs.release_id }}
              with:
                  script: |
                      github.rest.repos.updateRelease({
                        owner: context.repo.owner,
                        repo: context.repo.repo,
                        release_id: process.env.release_id,
                        draft: false,
                        prerelease: false
                      })
